{% extends "base.html" %}
{% load static %}

{% block title %}게시글 상세보기{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/board_detail.css' %}">
{% endblock %}

{% block content %}
    <div class="board-detail">
        <div class="board-header"> 
            <!-- 뒤로가기 버튼 -->
            <a href="{% url 'board:post_list_category' category=post.category %}" class="back-button" aria-label="이전 페이지로 이동">
                <svg width="35" height="35" viewBox="0 0 35 35" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M16.6249 17.5L23.3333 24.2083L21.2916 26.25L12.5416 17.5L21.2916 8.75L23.3333 10.7917L16.6249 17.5Z" fill="black" fill-opacity="0.28"/>
                </svg>
            </a>
            <span class="board-category">{{ post.category }} 게시판</span>
            
            <!-- 수정, 삭제 버튼 -->
            <form action="{% url 'board:post_edit' post.id %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="edit-button">수정</button>
            </form>
            <form action="{% url 'board:post_delete' post.id %}" method="POST">
                {% csrf_token %}
                <button type="submit" class="delete-button">삭제</button>
            </form>        
        </div>

        <div class="board-body">
            <!-- 작성자와 시간 표시 -->
            <div class="board-meta-top">
                <span class="board-author">{{ post.user }}</span>
                <span class="board-date">{{ post.date }}</span>
            </div>
            <!-- 게시글 제목과 내용 -->
            <h2 class="board-title">{{ post.title }}</h2>
            <p class="board-content">{{ post.content }}</p>
        </div>

        <div class="board-footer">
            <span class="board-meta">좋아요: {{ post.like_count }}</span>
            <span class="board-meta">댓글: {{ post.comment_count }}</span>
            <span class="board-meta">스크랩: {{ post.scrap_count }}</span>

            <!-- 스크랩 버튼 -->
            <form action="{% url 'board:post_scrap_toggle' post.pk %}" method="post" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="scrap-button">
                    {% if user in post.scraps.all %}
                        <!-- 이미 스크랩한 경우: 채워진 아이콘 -->
                        <svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M5.33975 20.1667L6.82933 13.7271L1.8335 9.39583L8.4335 8.82292L11.0002 2.75L13.5668 8.82292L20.1668 9.39583L15.171 13.7271L16.6606 20.1667L11.0002 16.7521L5.33975 20.1667Z" fill="#FFD559"/>
                        </svg>
                    {% else %}
                        <!-- 스크랩하지 않은 경우: 빈 아이콘 -->
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M9.99984 1.66663L12.5748 6.88329L18.3332 7.72496L14.1665 11.7833L15.1498 17.5166L9.99984 14.8083L4.84984 17.5166L5.83317 11.7833L1.6665 7.72496L7.42484 6.88329L9.99984 1.66663Z" stroke="#FFBF00" stroke-opacity="0.65" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    {% endif %}
                    <span class="scrap-count">{{ post.scrap_count }}</span> 
                </button>
            </form>
        </div>
    </div>
{% endblock %}


    
<!---------------------------------------------------------------------->
    <!--댓글 목록을 담을 영역-->
    <div id="comment-list"></div>
    
    <script>
   function loadBoardList() { 
  fetch(`/api/board/${boardId}/comment/`)
    .then(res => res.json())
    .then(data => {
      const commentList = document.getElementById("comment-list");
      commentList.innerHTML = "";
      
      data.comment.forEach(c => {
        const div = document.createElement("div");
        div.className = "comment-item";
        div.id = `comment-${c.id}`;   //댓글에 id를 붙여준다 (대댓글의 경우 부모댓글을 찾기위해)

        
        // 대댓글 버튼 이벤트
        div.querySelector(".reply-btn").addEventListener("click", (e) => {
          const commentId = e.currentTarget.dataset.id;
          div.style.backgroundColor = "#DBDEF625";
          const input = document.getElementById("commentInput");
          input.placeholder = "대댓글을 입력하세요";
          input.setAttribute("data-parent-id", commentId);
        });

        // 부모 댓글이면 바로 추가
        if (!c.parent_id) {
          commentList.appendChild(div);
        } else {
          // 대댓글이면 부모 댓글 아래에 추가
          const parentDiv = document.getElementById(`comment-${c.parent_id}`);
          if (parentDiv) {
            // 들여쓰기용 wrapper
            const replyWrapper = document.createElement("div");
            replyWrapper.style.marginLeft = "20px";
            replyWrapper.appendChild(div);
            parentDiv.appendChild(replyWrapper);
          } else {
            // 부모 못 찾으면 그냥 목록에 추가
            commentList.appendChild(div);
          }
        }
      });
    });
}

loadBoardList();

////////////////////////////////// 댓글 작성 이벤트
document.getElementById("submitComment").addEventListener("click", () => {   // 댓글 작성 버튼을 눌렀을때
  const content = document.getElementById("commentText").value.trim();       // commentText에 사용자가 입력한 내용을 가져온다
  const anonymous = document.getElementById("anonymousToggle").checked;      // 익명 체크박스가 체크되어있는지 확인 (체크면 true)
  const parentId = document.getElementById("commentText").dataset.parentId || null;  //대댓글일 경우 parentId에 저장. 없으면 null -> 일반 댓글이라는 뜻

  if (!content) return; //댓글이 비어있으면 아무것도 하지 않고 함수종료

  fetch(`/api/board/${boardId}/comment/`, {  // /api/board/${boardId}/comment/ 주소로 댓글을 post방식으로 보냄
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      content,
      anonymous,          // 서버에 보낼 데이터 -> 댓글 내용, 익명여부, 대댓글이면 부모댓글 Id 아니면 null값을 보냄
      parent_id: parentId
    })
  })
  .then(res => res.json())  // 서버의 응답을 json으로 받기
  .then(data => {
    document.getElementById("commentText").value = "";
    document.getElementById("commentText").removeAttribute("data-parent-id");  //대댓글 모드 해제
    document.getElementById("commentText").placeholder = "댓글을 입력하세요";  // placeholder 복원
    loadBoardList();
  });
});

// 초기 로딩
loadBoardList();
commentList.scrollIntoView({ behavior: "smooth", block: "end" });

    </script>
  
  <!---------------------------댓글 작성 영역 --------------------------------->

<!-- 댓글 입력 영역 -->
  <div class="comment-box-wrapper">
    <div class="comment-box">
      <!-- 익명 체크박스 -->
      <label class="anonymous-toggle">
        <input type="checkbox" id="anonymousToggle" />
        <label for="anonymousToggle" class="anonymous-label">
            익명
        </label>
      </label>

      <!-- 댓글 입력창 -->
      <input type="text" id="commentText" placeholder="댓글을 입력하세요" />

      <!-- 제출 버튼 (SVG 아이콘 포함) -->
      <button id="submitComment" class="send-button" aria-label="댓글 작성">
        <svg width="34" height="35" viewBox="0 0 34 35" fill="none" xmlns="http://www.w3.org/2000/svg">
        <g filter="url(#filter0_d_131_211)">
<path d="M28.3333 2.33337L15.5 15.1667M28.3333 2.33337L20.1667 25.6667L15.5 15.1667M28.3333 2.33337L5 10.5L15.5 15.1667" stroke="#00024F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </g>
        <defs>
<filter id="filter0_d_131_211" x="-1.3335" y="0" width="36" height="36" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
<feFlood flood-opacity="0" result="BackgroundImageFix"/>
<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
<feOffset dy="4"/>
<feGaussianBlur stdDeviation="2"/>
<feComposite in2="hardAlpha" operator="out"/>
<feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0.25 0"/>
<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_131_211"/>
<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_131_211" result="shape"/>
</filter>
        </defs>
        </svg>

      </button>
    </div>
  </div>

 